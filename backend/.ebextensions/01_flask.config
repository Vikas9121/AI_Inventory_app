option_settings:
  aws:elasticbeanstalk:container:python:
    WSGIPath: application:application
  aws:elasticbeanstalk:application:environment:
    FLASK_APP: application.py
    FLASK_ENV: production
    PYTHONPATH: "/var/app/current"
    LOGGING_LEVEL: INFO
  aws:elasticbeanstalk:environment:proxy:staticfiles:
    /static: static
  aws:elasticbeanstalk:cloudwatch:logs:
    StreamLogs: true
    DeleteOnTerminate: false
    RetentionInDays: 7

packages:
  yum:
    ca-certificates: []

commands:
  01_update_cert:
    command: yum update -y ca-certificates

container_commands:
  01_install_cert:
    command: |
      pip install --upgrade pip
      pip install --upgrade certifi
      export REQUESTS_CA_BUNDLE=/etc/pki/tls/certs/ca-bundle.crt
  01_create_dirs:
    command: |
      mkdir -p /var/log/app
      mkdir -p /var/app/current/data
      chmod 777 /var/log/app
      chmod 777 /var/app/current/data
  02_init_db:
    command: |
      cd /var/app/current
      python init_db.py
      if [ -f inventory.db ]; then
        mv inventory.db /var/app/current/data/
        chmod 666 /var/app/current/data/inventory.db
      fi
    leader_only: true